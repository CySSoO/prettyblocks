class p{constructor(t,e=e,s=s){this.events={},this.arr=[],this.tEdited,this.pApply,this.document=e,this.window=s,this.targets=t,this.targets.forEach(i=>{const l=Math.random().toString(36).substr(2,9);i.setAttribute("data-id-title",l);let n=i.dataset.attributes;const o=JSON.parse(n);this.arr.push({id:l,html:i,value:i.innerHTML,tag:i.tagName.toLowerCase(),classes:i.classList,focus:this.getAttributeValue(o,"focus"),inside:!1,bold:this.getAttributeValue(o,"bold"),italic:this.getAttributeValue(o,"italic"),underline:this.getAttributeValue(o,"underline"),size:this.getAttributeValue(o,"size")?this.getAttributeValue(o,"size"):32})});for(const i of this.arr){const l=i.id,n=this.document.querySelector('[data-id-title="'+l+'"]');n.setAttribute("contenteditable","true"),i.size=n.style.fontSize}this.toolbar=this.document.createElement("div"),this.toolbar.id="toolbar",this.document.getElementsByTagName("body")[0].appendChild(this.toolbar),this.select=this.document.createElement("select"),this.select.id="select",this.select.innerHTML=`
      <option value="h1">H1</option>
      <option value="h2">H2</option>
      <option value="h3">H3</option>
      <option value="h4">H4</option>
      <option value="h5">H5</option>
      <option value="h6">H6</option>
      <option value="p">p</option>
      <option value="span">span</option>
      `,this.select.selectedIndex=1,this.toolbar.appendChild(this.select),this.size=this.document.createElement("input"),this.size.id="size",this.size.type="number",this.size.value="32",this.size.min="1",this.size.max="100",this.size.step="1",this.toolbar.appendChild(this.size),this.sep=this.document.createElement("div"),this.sep.classList="sep",this.toolbar.appendChild(this.sep),this.B=this.document.createElement("button"),this.Bo=!1,this.B.id="Bold",this.B.innerHTML="B",this.toolbar.appendChild(this.B),this.I=this.document.createElement("button"),this.Io=!1,this.I.id="Italics",this.I.innerHTML="I",this.toolbar.appendChild(this.I),this.U=this.document.createElement("button"),this.Uo=!1,this.U.id="Underline",this.U.innerHTML="U",this.toolbar.appendChild(this.U),this.init(),this.setVisibility()}init(){for(const t of this.arr){let e=this.document.querySelector('[data-id-title="'+t.id+'"]');for(const s of this.targets)this.setBinging(s,t,e);this.select.addEventListener("change",()=>{const s={id:t.id,focus:t.focus,tag:this.select.value,classes:Array.from(e.classList),inside:t.inside,bold:t.bold,italic:t.italic,underline:t.underline,size:t.size},i=structuredClone(s);if(this.tEdited==t.id){let l=e.innerHTML,n=this.select.value,o=this.document.createElement(n);o.innerHTML=l,o.classList=e.classList,e.replaceWith(o);let r=e.getAttribute("data-block-id_prettyblock");o.setAttribute("data-block-id_prettyblock",r);let d=e.getAttribute("data-field");o.setAttribute("data-field",d),e=o,e.setAttribute("data-id-title",t.id),e.setAttribute("contenteditable","true"),t.bold==!0&&(e.style.fontWeight="bold"),t.italic==!0&&(e.style.fontStyle="italic"),t.underline==!0&&(e.style.textDecoration="underline"),e.style.fontSize=t.size+"px",this.setVisibility(),t.html=o,this.change(i,t),this.setBinging(o,t,e)}}),this.size.addEventListener("change",()=>{if(this.tEdited==t.id){const s={id:t.id,focus:t.focus,tag:this.select.value,classes:Array.from(e.classList),inside:t.inside,bold:t.bold,italic:t.italic,underline:t.underline,size:t.size},i=structuredClone(s);e.style.fontSize=this.size.value+"px",t.size=this.size.value,this.change(i,t)}}),this.B.addEventListener("click",()=>{if(this.tEdited==t.id){const s={id:t.id,focus:t.focus,tag:this.select.value,classes:Array.from(e.classList),inside:t.inside,bold:t.bold,italic:t.italic,underline:t.underline,size:t.size},i=structuredClone(s);t.bold==!1?(t.bold=!0,this.B.style.color="#6ae26a",e.style.fontWeight="bold",this.change(i,t)):(t.bold=!1,this.B.style.color="white",e.style.fontWeight="normal",this.change(i,t))}}),this.I.addEventListener("click",()=>{if(this.tEdited==t.id){const s={id:t.id,focus:t.focus,tag:this.select.value,classes:Array.from(e.classList),inside:t.inside,bold:t.bold,italic:t.italic,underline:t.underline,size:t.size},i=structuredClone(s);t.italic==!1?(t.italic=!0,this.I.style.color="#6ae26a",e.style.fontStyle="italic",this.change(i,t)):(t.italic=!1,this.I.style.color="white",e.style.fontStyle="normal",this.change(i,t))}}),this.U.addEventListener("click",()=>{if(this.tEdited==t.id){let s=!t.underline;console.log("underline",s),this.setAttributeValue(e,"underline",s),t.underline=s;const i={id:t.id,focus:t.focus,inside:t.inside,tag:this.select.value,classes:Array.from(e.classList),bold:t.bold,italic:t.italic,underline:t.underline,size:t.size},l=structuredClone(i);t.underline?(this.U.style.color="#6ae26a",e.style.textDecoration="underline"):(this.U.style.color="white",e.style.textDecoration="none"),this.change(l,t)}})}}setBinging(t,e,s){t.getAttribute("data-id-title")==e.id&&t.addEventListener("keydown",i=>{(i.ctrlKey&&i.key=="s"||i.ctrlKey&&i.key=="S"||i.metaKey&&i.key=="s"||i.metaKey&&i.key=="S")&&(i.preventDefault(),e.value=s.innerHTML,this.change(this.pApply,e),t.blur()),i.shiftKey&&i.key=="Enter"?(i.preventDefault(),this.document.execCommand("insertHTML",!1,"<br><br>")):i.key=="Enter"&&(i.preventDefault(),e.value=s.innerHTML,this.change(this.pApply,e),t.blur())})}getAttributeValue(t,e){return t.hasOwnProperty(e)?t[e]:!1}setAttributeValue(t,e,s){let i=t.getAttribute("data-attributes"),l=null;l=JSON.parse(i),l&&l.hasOwnProperty(e)?l[e]=s:console.log("L'attribut "+e+" n'existe pas dans l'objet."),console.log("OK",l),t.setAttribute("data-attributes",JSON.stringify(l||{}))}setVisibility(){for(const t of this.arr){const e=this.document.querySelector('[data-id-title="'+t.id+'"]');let s=!1,i=!1;e.addEventListener("mousedown",l=>{i=!0,this.toolbar.style.display="flex";const n=l.target.getAttribute("data-id-title"),o=this.arr.filter(d=>d.id==n)[0];this.refreshToolbar(o);const r={id:t.id,focus:t.focus,inside:t.inside,bold:t.bold,tag:this.select.value,italic:t.italic,underline:t.underline,size:t.size,value:l.target.innerHTML};this.pApply=structuredClone(r)}),e.addEventListener("mouseleave",()=>{s=!1,i||setTimeout(()=>{!s&&!i&&(this.toolbar.style.display="none")},1e3)}),e.addEventListener("focus",l=>{i=!0,this.toolbar.style.display="flex";const n=l.target.getAttribute("data-id-title"),o=this.arr.filter(r=>r.id==n)[0];this.refreshToolbar(o)}),e.addEventListener("blur",()=>{i=!1,s||setTimeout(()=>{!s&&!i&&(this.toolbar.style.display="none")},1e3)}),this.toolbar.addEventListener("mouseenter",l=>{s=!0,this.toolbar.style.display="flex"}),this.toolbar.addEventListener("mouseleave",l=>{const n=l.toElement||l.relatedTarget;s=!1,setTimeout(()=>{n&&(n.parentNode===this||n===this||n.parentNode===this.toolbar)||i||(this.toolbar.style.display="none")},1e3)})}}refreshToolbar(t){console.log("refreshToolbar",t);const e=t.id,s=this.document.querySelector('[data-id-title="'+e+'"]'),i=s.tagName.toLowerCase(),l=this.findTop(s),n=this.findLeft(s),o=Math.round(this.window.getComputedStyle(s,null).getPropertyValue("font-size").split("px")[0]),r=s.getBoundingClientRect(),d=this.toolbar.getBoundingClientRect();this.toolbar.style.top=l-d.height+55+"px",this.toolbar.style.left=n+r.width/2-d.width+"px",this.tEdited=t.id,this.size.value=o,t.size=o,i=="h1"&&(this.select.selectedIndex=0),i=="h2"&&(this.select.selectedIndex=1),i=="h3"&&(this.select.selectedIndex=2),i=="h4"&&(this.select.selectedIndex=3),i=="h5"&&(this.select.selectedIndex=4),i=="h6"&&(this.select.selectedIndex=5),i=="p"&&(this.select.selectedIndex=6),i=="span"&&(this.select.selectedIndex=7),t.bold?this.B.style.color="#6ae26a":this.B.style.color="white",t.italic?this.I.style.color="#6ae26a":this.I.style.color="white",t.underline?this.U.style.color="#6ae26a":this.U.style.color="white"}on(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push(e)}trigger(t,...e){const s=this.events[t];s&&s.forEach(i=>{i(...e)})}change(t,e){t.html=e.html,t.value=e.value,t.classes=e.classes,t.bold=e.bold,t.italic=e.italic,t.underline=e.underline,t.size=e.size,this.trigger("change",t,e)}apply(t,e){!e.inside&&!e.focus&&(t.html=e==null?void 0:e.html,e.value=e.html.innerHTML,this.trigger("apply",t,e))}findTop(t){var e=t.getBoundingClientRect();return e.top+this.window.scrollY}findLeft(t){var e=t.getBoundingClientRect();return e.left+this.window.scrollX}}window.hasEventListener=!1;const u=()=>{window.removeEventListener("message",f,!1)};let f=a=>{if(a.data.type=="getContext"){let t={id_lang:prestashop.language.id,id_shop:prestashop.modules.prettyblocks.id_shop,shop_name:prestashop.modules.prettyblocks.shop_name,current_url:prestashop.modules.prettyblocks.shop_current_url,href:window.location.href};return a.source.postMessage({type:"setContext",data:{data:t}},"*")}if(a.data.type=="initIframe")return document.querySelectorAll("div[data-block]").forEach(t=>{t.addEventListener("click",e=>{let s=e.target.closest("[data-id-prettyblocks]").getAttribute("data-id-prettyblocks");c(s),a.source.postMessage({type:"loadStateConfig",data:s},"*")})}),h(a);if(a.data.type=="focusOnZone"){let t=a.data.data;document.querySelectorAll(".border-dotted").forEach(s=>{s.classList.remove("border-dotted")});let e=document.querySelector('[data-prettyblocks-zone="'+t+'"]');return e.classList.add("border-dotted"),e.scrollIntoView({alignToTop:!0,behavior:"smooth",block:"center"})}if(a.data.type=="updateHTMLBlock"){let t=a.data.data.id_prettyblocks,e=a.data.data.html,s=document.querySelector('[data-id-prettyblocks="'+t+'"]');return s.innerHTML=e,h(a)}if(a.data.type=="scrollInIframe")return c(a.data.data);if(a.data.type=="getZones"){let t=document.querySelectorAll("[data-zone-name]"),e=[];return t.forEach(s=>{let i=s.getAttribute("data-zone-name");e.indexOf(i)==-1&&e.push(i)}),a.source.postMessage({type:"zones",data:e},"*")}u()};const c=a=>{let t=document,e=t.querySelector('[data-id-prettyblocks="'+a+'"]');t.body.contains(e)&&(e.scrollIntoView({alignToTop:!1,behavior:"smooth",block:"center"}),t.querySelectorAll("[data-block]").forEach(i=>{i.classList.remove("border-dotted")}),e.classList.add("border-dotted"))},h=a=>{new p(document.querySelectorAll(".ptb-title"),document,window).on("change",async(e,s)=>{let i={id_prettyblocks:e.html.closest("[data-id-prettyblocks]").getAttribute("data-id-prettyblocks"),field:e.html.getAttribute("data-field"),index:e.html.hasAttribute("data-index")?e.html.getAttribute("data-index"):null};a.source.postMessage({type:"updateTitleComponent",data:{params:i,value:JSON.stringify(s)}},"*")})};document.addEventListener("DOMContentLoaded",a=>{window.hasEventListener||(console.log("subscribe"),window.addEventListener("message",f,!1),window.hasEventListener=!0)});u();
